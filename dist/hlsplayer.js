(function(root, factory) {
  if (typeof define === 'function' && define.amd) {
    define([], factory);
  } else if (typeof exports === 'object') {
    module.exports = factory();
  } else {
    root.HLSPlayer = factory();
  }
}(this, function() {
'use strict';

function HLSPlayer(canvas, manifestUrl, options) {
  options = options || {};

  var workerSrc = 'var requirejs,require,define;(function(e){function h(e,t){return f.call(e,t)}function p(e,t){var n,r,i,s,o,a,f,l,h,p,d,v=t&&t.split("/"),m=u.map,g=m&&m["*"]||{};if(e&&e.charAt(0)===".")if(t){e=e.split("/"),o=e.length-1,u.nodeIdCompat&&c.test(e[o])&&(e[o]=e[o].replace(c,"")),e=v.slice(0,v.length-1).concat(e);for(h=0;h<e.length;h+=1){d=e[h];if(d===".")e.splice(h,1),h-=1;else if(d===".."){if(h===1&&(e[2]===".."||e[0]===".."))break;h>0&&(e.splice(h-1,2),h-=2)}}e=e.join("/")}else e.indexOf("./")===0&&(e=e.substring(2));if((v||g)&&m){n=e.split("/");for(h=n.length;h>0;h-=1){r=n.slice(0,h).join("/");if(v)for(p=v.length;p>0;p-=1){i=m[v.slice(0,p).join("/")];if(i){i=i[r];if(i){s=i,a=h;break}}}if(s)break;!f&&g&&g[r]&&(f=g[r],l=h)}!s&&f&&(s=f,a=l),s&&(n.splice(0,a,s),e=n.join("/"))}return e}function d(t,r){return function(){var i=l.call(arguments,0);return typeof i[0]!="string"&&i.length===1&&i.push(null),n.apply(e,i.concat([t,r]))}}function v(e){return function(t){return p(t,e)}}function m(e){return function(t){s[e]=t}}function g(n){if(h(o,n)){var r=o[n];delete o[n],a[n]=!0,t.apply(e,r)}if(!h(s,n)&&!h(a,n))throw new Error("No "+n);return s[n]}function y(e){var t,n=e?e.indexOf("!"):-1;return n>-1&&(t=e.substring(0,n),e=e.substring(n+1,e.length)),[t,e]}function b(e){return function(){return u&&u.config&&u.config[e]||{}}}var t,n,r,i,s={},o={},u={},a={},f=Object.prototype.hasOwnProperty,l=[].slice,c=/\.js$/;r=function(e,t){var n,r=y(e),i=r[0];return e=r[1],i&&(i=p(i,t),n=g(i)),i?n&&n.normalize?e=n.normalize(e,v(t)):e=p(e,t):(e=p(e,t),r=y(e),i=r[0],e=r[1],i&&(n=g(i))),{f:i?i+"!"+e:e,n:e,pr:i,p:n}},i={require:function(e){return d(e)},exports:function(e){var t=s[e];return typeof t!="undefined"?t:s[e]={}},module:function(e){return{id:e,uri:"",exports:s[e],config:b(e)}}},t=function(t,n,u,f){var l,c,p,v,y,b=[],w=typeof u,E;f=f||t;if(w==="undefined"||w==="function"){n=!n.length&&u.length?["require","exports","module"]:n;for(y=0;y<n.length;y+=1){v=r(n[y],f),c=v.f;if(c==="require")b[y]=i.require(t);else if(c==="exports")b[y]=i.exports(t),E=!0;else if(c==="module")l=b[y]=i.module(t);else if(h(s,c)||h(o,c)||h(a,c))b[y]=g(c);else{if(!v.p)throw new Error(t+" missing "+c);v.p.load(v.n,d(f,!0),m(c),{}),b[y]=s[c]}}p=u?u.apply(s[t],b):undefined;if(t)if(l&&l.exports!==e&&l.exports!==s[t])s[t]=l.exports;else if(p!==e||!E)s[t]=p}else t&&(s[t]=u)},requirejs=require=n=function(s,o,a,f,l){if(typeof s=="string")return i[s]?i[s](o):g(r(s,o).f);if(!s.splice){u=s,u.deps&&n(u.deps,u.callback);if(!o)return;o.splice?(s=o,o=a,a=null):s=e}return o=o||function(){},typeof a=="function"&&(a=f,f=l),f?t(e,s,o,a):setTimeout(function(){t(e,s,o,a)},4),n},n.config=function(e){return n(e)},requirejs._defined=s,define=function(e,t,n){if(typeof e!="string")throw new Error("See almond README: incorrect module build, no module name");t.splice||(n=t,t=[]),!h(s,e)&&!h(o,e)&&(o[e]=[e,t,n])},define.amd={jQuery:!0}})(),define("bower_components/almond/almond",function(){}),function(){function r(e){var n=!1;return function(){if(n)throw new Error("Callback was already called.");n=!0,e.apply(t,arguments)}}var e={},t,n;t=this,t!=null&&(n=t.async),e.noConflict=function(){return t.async=n,e};var i=Object.prototype.toString,s=Array.isArray||function(e){return i.call(e)==="[object Array]"},o=function(e,t){for(var n=0;n<e.length;n+=1)t(e[n],n,e)},u=function(e,t){if(e.map)return e.map(t);var n=[];return o(e,function(e,r,i){n.push(t(e,r,i))}),n},a=function(e,t,n){return e.reduce?e.reduce(t,n):(o(e,function(e,r,i){n=t(n,e,r,i)}),n)},f=function(e){if(Object.keys)return Object.keys(e);var t=[];for(var n in e)e.hasOwnProperty(n)&&t.push(n);return t};typeof process=="undefined"||!process.nextTick?typeof setImmediate=="function"?(e.nextTick=function(e){setImmediate(e)},e.setImmediate=e.nextTick):(e.nextTick=function(e){setTimeout(e,0)},e.setImmediate=e.nextTick):(e.nextTick=process.nextTick,typeof setImmediate!="undefined"?e.setImmediate=function(e){setImmediate(e)}:e.setImmediate=e.nextTick),e.each=function(e,t,n){function s(t){t?(n(t),n=function(){}):(i+=1,i>=e.length&&n())}n=n||function(){};if(!e.length)return n();var i=0;o(e,function(e){t(e,r(s))})},e.forEach=e.each,e.eachSeries=function(e,t,n){n=n||function(){};if(!e.length)return n();var r=0,i=function(){t(e[r],function(t){t?(n(t),n=function(){}):(r+=1,r>=e.length?n():i())})};i()},e.forEachSeries=e.eachSeries,e.eachLimit=function(e,t,n,r){var i=l(t);i.apply(null,[e,n,r])},e.forEachLimit=e.eachLimit;var l=function(e){return function(t,n,r){r=r||function(){};if(!t.length||e<=0)return r();var i=0,s=0,o=0;(function u(){if(i>=t.length)return r();while(o<e&&s<t.length)s+=1,o+=1,n(t[s-1],function(e){e?(r(e),r=function(){}):(i+=1,o-=1,i>=t.length?r():u())})})()}},c=function(t){return function(){var n=Array.prototype.slice.call(arguments);return t.apply(null,[e.each].concat(n))}},h=function(e,t){return function(){var n=Array.prototype.slice.call(arguments);return t.apply(null,[l(e)].concat(n))}},p=function(t){return function(){var n=Array.prototype.slice.call(arguments);return t.apply(null,[e.eachSeries].concat(n))}},d=function(e,t,n,r){t=u(t,function(e,t){return{index:t,value:e}});if(!r)e(t,function(e,t){n(e.value,function(e){t(e)})});else{var i=[];e(t,function(e,t){n(e.value,function(n,r){i[e.index]=r,t(n)})},function(e){r(e,i)})}};e.map=c(d),e.mapSeries=p(d),e.mapLimit=function(e,t,n,r){return v(t)(e,n,r)};var v=function(e){return h(e,d)};e.reduce=function(t,n,r,i){e.eachSeries(t,function(e,t){r(n,e,function(e,r){n=r,t(e)})},function(e){i(e,n)})},e.inject=e.reduce,e.foldl=e.reduce,e.reduceRight=function(t,n,r,i){var s=u(t,function(e){return e}).reverse();e.reduce(s,n,r,i)},e.foldr=e.reduceRight;var m=function(e,t,n,r){var i=[];t=u(t,function(e,t){return{index:t,value:e}}),e(t,function(e,t){n(e.value,function(n){n&&i.push(e),t()})},function(e){r(u(i.sort(function(e,t){return e.index-t.index}),function(e){return e.value}))})};e.filter=c(m),e.filterSeries=p(m),e.select=e.filter,e.selectSeries=e.filterSeries;var g=function(e,t,n,r){var i=[];t=u(t,function(e,t){return{index:t,value:e}}),e(t,function(e,t){n(e.value,function(n){n||i.push(e),t()})},function(e){r(u(i.sort(function(e,t){return e.index-t.index}),function(e){return e.value}))})};e.reject=c(g),e.rejectSeries=p(g);var y=function(e,t,n,r){e(t,function(e,t){n(e,function(n){n?(r(e),r=function(){}):t()})},function(e){r()})};e.detect=c(y),e.detectSeries=p(y),e.some=function(t,n,r){e.each(t,function(e,t){n(e,function(e){e&&(r(!0),r=function(){}),t()})},function(e){r(!1)})},e.any=e.some,e.every=function(t,n,r){e.each(t,function(e,t){n(e,function(e){e||(r(!1),r=function(){}),t()})},function(e){r(!0)})},e.all=e.every,e.sortBy=function(t,n,r){e.map(t,function(e,t){n(e,function(n,r){n?t(n):t(null,{value:e,criteria:r})})},function(e,t){if(e)return r(e);var n=function(e,t){var n=e.criteria,r=t.criteria;return n<r?-1:n>r?1:0};r(null,u(t.sort(n),function(e){return e.value}))})},e.auto=function(t,n){n=n||function(){};var r=f(t),i=r.length;if(!i)return n();var u={},l=[],c=function(e){l.unshift(e)},h=function(e){for(var t=0;t<l.length;t+=1)if(l[t]===e){l.splice(t,1);return}},p=function(){i--,o(l.slice(0),function(e){e()})};c(function(){if(!i){var e=n;n=function(){},e(null,u)}}),o(r,function(r){var i=s(t[r])?t[r]:[t[r]],l=function(t){var i=Array.prototype.slice.call(arguments,1);i.length<=1&&(i=i[0]);if(t){var s={};o(f(u),function(e){s[e]=u[e]}),s[r]=i,n(t,s),n=function(){}}else u[r]=i,e.setImmediate(p)},d=i.slice(0,Math.abs(i.length-1))||[],v=function(){return a(d,function(e,t){return e&&u.hasOwnProperty(t)},!0)&&!u.hasOwnProperty(r)};if(v())i[i.length-1](l,u);else{var m=function(){v()&&(h(m),i[i.length-1](l,u))};c(m)}})},e.retry=function(t,n,r){var i=5,s=[];typeof t=="function"&&(r=n,n=t,t=i),t=parseInt(t,10)||i;var o=function(i,o){var u=function(e,t){return function(n){e(function(e,r){n(!e||t,{err:e,result:r})},o)}};while(t)s.push(u(n,!(t-=1)));e.series(s,function(e,t){t=t[t.length-1],(i||r)(t.err,t.result)})};return r?o():o},e.waterfall=function(t,n){n=n||function(){};if(!s(t)){var r=new Error("First argument to waterfall must be an array of functions");return n(r)}if(!t.length)return n();var i=function(t){return function(r){if(r)n.apply(null,arguments),n=function(){};else{var s=Array.prototype.slice.call(arguments,1),o=t.next();o?s.push(i(o)):s.push(n),e.setImmediate(function(){t.apply(null,s)})}}};i(e.iterator(t))()};var b=function(e,t,n){n=n||function(){};if(s(t))e.map(t,function(e,t){e&&e(function(e){var n=Array.prototype.slice.call(arguments,1);n.length<=1&&(n=n[0]),t.call(null,e,n)})},n);else{var r={};e.each(f(t),function(e,n){t[e](function(t){var i=Array.prototype.slice.call(arguments,1);i.length<=1&&(i=i[0]),r[e]=i,n(t)})},function(e){n(e,r)})}};e.parallel=function(t,n){b({map:e.map,each:e.each},t,n)},e.parallelLimit=function(e,t,n){b({map:v(t),each:l(t)},e,n)},e.series=function(t,n){n=n||function(){};if(s(t))e.mapSeries(t,function(e,t){e&&e(function(e){var n=Array.prototype.slice.call(arguments,1);n.length<=1&&(n=n[0]),t.call(null,e,n)})},n);else{var r={};e.eachSeries(f(t),function(e,n){t[e](function(t){var i=Array.prototype.slice.call(arguments,1);i.length<=1&&(i=i[0]),r[e]=i,n(t)})},function(e){n(e,r)})}},e.iterator=function(e){var t=function(n){var r=function(){return e.length&&e[n].apply(null,arguments),r.next()};return r.next=function(){return n<e.length-1?t(n+1):null},r};return t(0)},e.apply=function(e){var t=Array.prototype.slice.call(arguments,1);return function(){return e.apply(null,t.concat(Array.prototype.slice.call(arguments)))}};var w=function(e,t,n,r){var i=[];e(t,function(e,t){n(e,function(e,n){i=i.concat(n||[]),t(e)})},function(e){r(e,i)})};e.concat=c(w),e.concatSeries=p(w),e.whilst=function(t,n,r){t()?n(function(i){if(i)return r(i);e.whilst(t,n,r)}):r()},e.doWhilst=function(t,n,r){t(function(i){if(i)return r(i);var s=Array.prototype.slice.call(arguments,1);n.apply(null,s)?e.doWhilst(t,n,r):r()})},e.until=function(t,n,r){t()?r():n(function(i){if(i)return r(i);e.until(t,n,r)})},e.doUntil=function(t,n,r){t(function(i){if(i)return r(i);var s=Array.prototype.slice.call(arguments,1);n.apply(null,s)?r():e.doUntil(t,n,r)})},e.queue=function(t,n){function i(t,n,r,i){t.started||(t.started=!0),s(n)||(n=[n]);if(n.length==0)return e.setImmediate(function(){t.drain&&t.drain()});o(n,function(n){var s={data:n,callback:typeof i=="function"?i:null};r?t.tasks.unshift(s):t.tasks.push(s),t.saturated&&t.tasks.length===t.concurrency&&t.saturated(),e.setImmediate(t.process)})}n===undefined&&(n=1);var u=0,a={tasks:[],concurrency:n,saturated:null,empty:null,drain:null,started:!1,paused:!1,push:function(e,t){i(a,e,!1,t)},kill:function(){a.drain=null,a.tasks=[]},unshift:function(e,t){i(a,e,!0,t)},process:function(){if(!a.paused&&u<a.concurrency&&a.tasks.length){var e=a.tasks.shift();a.empty&&a.tasks.length===0&&a.empty(),u+=1;var n=function(){u-=1,e.callback&&e.callback.apply(e,arguments),a.drain&&a.tasks.length+u===0&&a.drain(),a.process()},i=r(n);t(e.data,i)}},length:function(){return a.tasks.length},running:function(){return u},idle:function(){return a.tasks.length+u===0},pause:function(){if(a.paused===!0)return;a.paused=!0},resume:function(){if(a.paused===!1)return;a.paused=!1;for(var t=1;t<=a.concurrency;t++)e.setImmediate(a.process)}};return a},e.priorityQueue=function(t,n){function r(e,t){return e.priority-t.priority}function i(e,t,n){var r=-1,i=e.length-1;while(r<i){var s=r+(i-r+1>>>1);n(t,e[s])>=0?r=s:i=s-1}return r}function u(t,n,u,a){t.started||(t.started=!0),s(n)||(n=[n]);if(n.length==0)return e.setImmediate(function(){t.drain&&t.drain()});o(n,function(n){var s={data:n,priority:u,callback:typeof a=="function"?a:null};t.tasks.splice(i(t.tasks,s,r)+1,0,s),t.saturated&&t.tasks.length===t.concurrency&&t.saturated(),e.setImmediate(t.process)})}var a=e.queue(t,n);return a.push=function(e,t,n){u(a,e,t,n)},delete a.unshift,a},e.cargo=function(t,n){var r=!1,i=[],a={tasks:i,payload:n,saturated:null,empty:null,drain:null,drained:!0,push:function(t,r){s(t)||(t=[t]),o(t,function(e){i.push({data:e,callback:typeof r=="function"?r:null}),a.drained=!1,a.saturated&&i.length===n&&a.saturated()}),e.setImmediate(a.process)},process:function f(){if(r)return;if(i.length===0){a.drain&&!a.drained&&a.drain(),a.drained=!0;return}var e=typeof n=="number"?i.splice(0,n):i.splice(0,i.length),s=u(e,function(e){return e.data});a.empty&&a.empty(),r=!0,t(s,function(){r=!1;var t=arguments;o(e,function(e){e.callback&&e.callback.apply(null,t)}),f()})},length:function(){return i.length},running:function(){return r}};return a};var E=function(e){return function(t){var n=Array.prototype.slice.call(arguments,1);t.apply(null,n.concat([function(t){var n=Array.prototype.slice.call(arguments,1);typeof console!="undefined"&&(t?console.error&&console.error(t):console[e]&&o(n,function(t){console[e](t)}))}]))}};e.log=E("log"),e.dir=E("dir"),e.memoize=function(t,n){var r={},i={};n=n||function(e){return e};var s=function(){var s=Array.prototype.slice.call(arguments),o=s.pop(),u=n.apply(null,s);u in r?e.nextTick(function(){o.apply(null,r[u])}):u in i?i[u].push(o):(i[u]=[o],t.apply(null,s.concat([function(){r[u]=arguments;var e=i[u];delete i[u];for(var t=0,n=e.length;t<n;t++)e[t].apply(null,arguments)}])))};return s.memo=r,s.unmemoized=t,s},e.unmemoize=function(e){return function(){return(e.unmemoized||e).apply(null,arguments)}},e.times=function(t,n,r){var i=[];for(var s=0;s<t;s++)i.push(s);return e.map(i,n,r)},e.timesSeries=function(t,n,r){var i=[];for(var s=0;s<t;s++)i.push(s);return e.mapSeries(i,n,r)},e.seq=function(){var t=arguments;return function(){var n=this,r=Array.prototype.slice.call(arguments),i=r.pop();e.reduce(t,r,function(e,t,r){t.apply(n,e.concat([function(){var e=arguments[0],t=Array.prototype.slice.call(arguments,1);r(e,t)}]))},function(e,t){i.apply(n,[e].concat(t))})}},e.compose=function(){return e.seq.apply(null,Array.prototype.reverse.call(arguments))};var S=function(e,t){var n=function(){var n=this,r=Array.prototype.slice.call(arguments),i=r.pop();return e(t,function(e,t){e.apply(n,r.concat([t]))},i)};if(arguments.length>2){var r=Array.prototype.slice.call(arguments,2);return n.apply(this,r)}return n};e.applyEach=c(S),e.applyEachSeries=p(S),e.forever=function(e,t){function n(r){if(r){if(t)return t(r);throw r}e(n)}n()},typeof module!="undefined"&&module.exports?module.exports=e:typeof define!="undefined"&&define.amd?define("async",[],function(){return e}):t.async=e}(),!function(e){var t=this;"object"==typeof exports?module.exports=e(t):"function"==typeof define&&define.amd?define("jdataview",[],function(){return e(t)}):t.jDataView=e(t)}(function(e){function t(e,t){return"object"!=typeof e||null===e?!1:e.constructor===t||Object.prototype.toString.call(e)==="[object "+t.name+"]"}function n(e,n){return!n&&t(e,Array)?e:Array.prototype.slice.call(e)}function r(e,t){return void 0!==e?e:t}function i(e,n,s,o){if(i.is(e)){var u=e.slice(n,n+s);return u._littleEndian=r(o,u._littleEndian),u}if(!i.is(this))return new i(e,n,s,o);if(this.buffer=e=i.wrapBuffer(e),this._isArrayBuffer=f.ArrayBuffer&&t(e,ArrayBuffer),this._isPixelData=f.PixelData&&t(e,CanvasPixelArray),this._isDataView=f.DataView&&this._isArrayBuffer,this._isNodeBuffer=!1,!this._isArrayBuffer&&!this._isPixelData&&!t(e,Array))throw new TypeError("jDataView buffer has an incompatible type");this._littleEndian=!!o;var a="byteLength"in e?e.byteLength:e.length;this.byteOffset=n=r(n,0),this.byteLength=s=r(s,a-n),this._offset=this._bitOffset=0,this._isDataView?this._view=new DataView(e,n,s):this._checkBounds(n,s,a),this._engineAction=this._isDataView?this._dataViewAction:this._isArrayBuffer?this._arrayBufferAction:this._arrayAction}function s(e){for(var t=f.ArrayBuffer?Uint8Array:Array,n=new t(e.length),r=0,i=e.length;i>r;r++)n[r]=255&e.charCodeAt(r);return n}function o(e){return e>=0&&31>e?1<<e:o[e]||(o[e]=Math.pow(2,e))}function u(e,t){this.lo=e,this.hi=t}function a(){u.apply(this,arguments)}var f={NodeBuffer:!1,DataView:"DataView"in e,ArrayBuffer:"ArrayBuffer"in e,PixelData:"CanvasPixelArray"in e&&!("Uint8ClampedArray"in e)&&"document"in e},l=e.TextEncoder,c=e.TextDecoder;if(f.PixelData)var h=document.createElement("canvas").getContext("2d"),p=function(e,t){var n=h.createImageData((e+3)/4,1).data;if(n.byteLength=e,void 0!==t)for(var r=0;e>r;r++)n[r]=t[r];return n};var d={Int8:1,Int16:2,Int32:4,Uint8:1,Uint16:2,Uint32:4,Float32:4,Float64:8};i.wrapBuffer=function(e){switch(typeof e){case"number":if(f.ArrayBuffer)e=(new Uint8Array(e)).buffer;else if(f.PixelData)e=p(e);else{e=new Array(e);for(var r=0;r<e.length;r++)e[r]=0}return e;case"string":e=s(e);default:return"length"in e&&!(f.ArrayBuffer&&t(e,ArrayBuffer)||f.PixelData&&t(e,CanvasPixelArray))&&(f.ArrayBuffer?t(e,ArrayBuffer)||(e=(new Uint8Array(e)).buffer,t(e,ArrayBuffer)||(e=(new Uint8Array(n(e,!0))).buffer)):e=f.PixelData?p(e.length,e):n(e)),e}},i.is=function(e){return e&&e.jDataView},i.from=function(){return new i(arguments)},i.Uint64=u,u.prototype={valueOf:function(){return this.lo+o(32)*this.hi},toString:function(){return Number.prototype.toString.apply(this.valueOf(),arguments)}},u.fromNumber=function(e){var t=Math.floor(e/o(32)),n=e-t*o(32);return new u(n,t)},i.Int64=a,a.prototype="create"in Object?Object.create(u.prototype):new u,a.prototype.valueOf=function(){return this.hi<o(31)?u.prototype.valueOf.apply(this,arguments):-(o(32)-this.lo+o(32)*(o(32)-1-this.hi))},a.fromNumber=function(e){var t,n;if(e>=0){var r=u.fromNumber(e);t=r.lo,n=r.hi}else n=Math.floor(e/o(32)),t=e-n*o(32),n+=o(32);return new a(t,n)};var v=i.prototype={compatibility:f,jDataView:!0,_checkBounds:function(e,t,n){if("number"!=typeof e)throw new TypeError("Offset is not a number.");if("number"!=typeof t)throw new TypeError("Size is not a number.");if(0>t)throw new RangeError("Length is negative.");if(0>e||e+t>r(n,this.byteLength))throw new RangeError("Offsets are out of bounds.")},_action:function(e,t,n,i,s){return this._engineAction(e,t,r(n,this._offset),r(i,this._littleEndian),s)},_dataViewAction:function(e,t,n,r,i){return this._offset=n+d[e],t?this._view["get"+e](n,r):this._view["set"+e](n,i,r)},_arrayBufferAction:function(t,n,i,s,o){var u,a=d[t],f=e[t+"Array"];if(s=r(s,this._littleEndian),1===a||(this.byteOffset+i)%a===0&&s)return u=new f(this.buffer,this.byteOffset+i,1),this._offset=i+a,n?u[0]:u[0]=o;var l=new Uint8Array(n?this.getBytes(a,i,s,!0):a);return u=new f(l.buffer,0,1),n?u[0]:(u[0]=o,void this._setBytes(i,l,s))},_arrayAction:function(e,t,n,r,i){return t?this["_get"+e](n,r):this["_set"+e](n,i,r)},_getBytes:function(e,t,i){i=r(i,this._littleEndian),t=r(t,this._offset),e=r(e,this.byteLength-t),this._checkBounds(t,e),t+=this.byteOffset,this._offset=t-this.byteOffset+e;var s=this._isArrayBuffer?new Uint8Array(this.buffer,t,e):(this.buffer.slice||Array.prototype.slice).call(this.buffer,t,t+e);return i||1>=e?s:n(s).reverse()},getBytes:function(e,t,i,s){var o=this._getBytes(e,t,r(i,!0));return s?n(o):o},_setBytes:function(e,t,i){var s=t.length;if(0!==s){if(i=r(i,this._littleEndian),e=r(e,this._offset),this._checkBounds(e,s),!i&&s>1&&(t=n(t,!0).reverse()),e+=this.byteOffset,this._isArrayBuffer)(new Uint8Array(this.buffer,e,s)).set(t);else for(var o=0;s>o;o++)this.buffer[e+o]=t[o];this._offset=e-this.byteOffset+s}},setBytes:function(e,t,n){this._setBytes(e,t,r(n,!0))},getString:function(e,t,n){var r=this._getBytes(e,t,!0);if(n="utf8"===n?"utf-8":n||"binary",c&&"binary"!==n)return(new c(n)).decode(this._isArrayBuffer?r:new Uint8Array(r));var i="";e=r.length;for(var s=0;e>s;s++)i+=String.fromCharCode(r[s]);return"utf-8"===n&&(i=decodeURIComponent(escape(i))),i},setString:function(e,t,n){n="utf8"===n?"utf-8":n||"binary";var r;l&&"binary"!==n?r=(new l(n)).encode(t):("utf-8"===n&&(t=unescape(encodeURIComponent(t))),r=s(t)),this._setBytes(e,r,!0)},getChar:function(e){return this.getString(1,e)},setChar:function(e,t){this.setString(e,t)},tell:function(){return this._offset},seek:function(e){return this._checkBounds(e,0),this._offset=e},skip:function(e){return this.seek(this._offset+e)},slice:function(e,t,n){function s(e,t){return 0>e?e+t:e}return e=s(e,this.byteLength),t=s(r(t,this.byteLength),this.byteLength),n?new i(this.getBytes(t-e,e,!0,!0),void 0,void 0,this._littleEndian):new i(this.buffer,this.byteOffset+e,t-e,this._littleEndian)},alignBy:function(e){return this._bitOffset=0,1!==r(e,1)?this.skip(e-(this._offset%e||e)):this._offset},_getFloat64:function(e,t){var n=this._getBytes(8,e,t),r=1-2*(n[7]>>7),i=((n[7]<<1&255)<<3|n[6]>>4)-1023,s=(15&n[6])*o(48)+n[5]*o(40)+n[4]*o(32)+n[3]*o(24)+n[2]*o(16)+n[1]*o(8)+n[0];return 1024===i?0!==s?0/0:1/0*r:-1023===i?r*s*o(-1074):r*(1+s*o(-52))*o(i)},_getFloat32:function(e,t){var n=this._getBytes(4,e,t),r=1-2*(n[3]>>7),i=(n[3]<<1&255|n[2]>>7)-127,s=(127&n[2])<<16|n[1]<<8|n[0];return 128===i?0!==s?0/0:1/0*r:-127===i?r*s*o(-149):r*(1+s*o(-23))*o(i)},_get64:function(e,t,n){n=r(n,this._littleEndian),t=r(t,this._offset);for(var i=n?[0,4]:[4,0],s=0;2>s;s++)i[s]=this.getUint32(t+i[s],n);return this._offset=t+8,new e(i[0],i[1])},getInt64:function(e,t){return this._get64(a,e,t)},getUint64:function(e,t){return this._get64(u,e,t)},_getInt32:function(e,t){var n=this._getBytes(4,e,t);return n[3]<<24|n[2]<<16|n[1]<<8|n[0]},_getUint32:function(e,t){return this._getInt32(e,t)>>>0},_getInt16:function(e,t){return this._getUint16(e,t)<<16>>16},_getUint16:function(e,t){var n=this._getBytes(2,e,t);return n[1]<<8|n[0]},_getInt8:function(e){return this._getUint8(e)<<24>>24},_getUint8:function(e){return this._getBytes(1,e)[0]},_getBitRangeData:function(e,t){var n=(r(t,this._offset)<<3)+this._bitOffset,i=n+e,s=n>>>3,o=i+7>>>3,u=this._getBytes(o-s,s,!0),a=0;(this._bitOffset=7&i)&&(this._bitOffset-=8);for(var f=0,l=u.length;l>f;f++)a=a<<8|u[f];return{start:s,bytes:u,wideValue:a}},getSigned:function(e,t){var n=32-e;return this.getUnsigned(e,t)<<n>>n},getUnsigned:function(e,t){var n=this._getBitRangeData(e,t).wideValue>>>-this._bitOffset;return 32>e?n&~(-1<<e):n},_setBinaryFloat:function(e,t,n,r,i){var s,u,a=0>t?1:0,f=~(-1<<r-1),l=1-f;0>t&&(t=-t),0===t?(s=0,u=0):isNaN(t)?(s=2*f+1,u=1):1/0===t?(s=2*f+1,u=0):(s=Math.floor(Math.log(t)/Math.LN2),s>=l&&f>=s?(u=Math.floor((t*o(-s)-1)*o(n)),s+=f):(u=Math.floor(t/o(l-n)),s=0));for(var c=[];n>=8;)c.push(u%256),u=Math.floor(u/256),n-=8;for(s=s<<n|u,r+=n;r>=8;)c.push(255&s),s>>>=8,r-=8;c.push(a<<r|s),this._setBytes(e,c,i)},_setFloat32:function(e,t,n){this._setBinaryFloat(e,t,23,8,n)},_setFloat64:function(e,t,n){this._setBinaryFloat(e,t,52,11,n)},_set64:function(e,t,n,i){"object"!=typeof n&&(n=e.fromNumber(n)),i=r(i,this._littleEndian),t=r(t,this._offset);var s=i?{lo:0,hi:4}:{lo:4,hi:0};for(var o in s)this.setUint32(t+s[o],n[o],i);this._offset=t+8},setInt64:function(e,t,n){this._set64(a,e,t,n)},setUint64:function(e,t,n){this._set64(u,e,t,n)},_setUint32:function(e,t,n){this._setBytes(e,[255&t,t>>>8&255,t>>>16&255,t>>>24],n)},_setUint16:function(e,t,n){this._setBytes(e,[255&t,t>>>8&255],n)},_setUint8:function(e,t){this._setBytes(e,[255&t])},setUnsigned:function(e,t,n){var r=this._getBitRangeData(n,e),i=r.wideValue,s=r.bytes;i&=~(~(-1<<n)<<-this._bitOffset),i|=(32>n?t&~(-1<<n):t)<<-this._bitOffset;for(var o=s.length-1;o>=0;o--)s[o]=255&i,i>>>=8;this._setBytes(r.start,s,!0)}};for(var m in d)!function(e){v["get"+e]=function(t,n){return this._action(e,!0,t,n)},v["set"+e]=function(t,n,r){this._action(e,!1,t,r,n)}}(m);v._setInt32=v._setUint32,v._setInt16=v._setUint16,v._setInt8=v._setUint8,v.setSigned=v.setUnsigned;for(var g in v)"set"===g.slice(0,3)&&!function(e){v["write"+e]=function(){Array.prototype.unshift.call(arguments,void 0),this["set"+e].apply(this,arguments)}}(g.slice(3));return i}),!function(e){var t=this;"object"==typeof exports?module.exports=e(t,require("jdataview")):"function"==typeof define&&define.amd?define("jbinary",["jdataview"],function(n){return e(t,n)}):t.jBinary=e(t,t.jDataView)}(function(e,t){function n(e,t){return t&&e instanceof t}function r(e){for(var t=1,n=arguments.length;n>t;++t){var r=arguments[t];for(var i in r)void 0!==r[i]&&(e[i]=r[i])}return e}function i(e){return arguments[0]=h(e),r.apply(null,arguments)}function s(e,t,r){return n(r,Function)?r.call(e,t.contexts[0]):r}function o(e){return function(){var t=arguments,r=t.length-1,i=e.length-1,s=t[r];if(t.length=i+1,!n(s,Function)){var o=this;return new c(function(n,r){t[i]=function(e,t){return e?r(e):n(t)},e.apply(o,t)})}t[r]=void 0,t[i]=s,e.apply(this,t)}}function u(e,r){return n(e,u)?e.as(r):(n(e,t)||(e=new t(e,void 0,void 0,r?r["jBinary.littleEndian"]:void 0)),n(this,u)?(this.view=e,this.view.seek(0),this.contexts=[],this.as(r,!0)):new u(e,r))}function a(e){return i(a.prototype,e)}function f(e){return i(f.prototype,e,{createProperty:function(){var t=(e.createProperty||f.prototype.createProperty).apply(this,arguments);return t.getBaseType&&(t.baseType=t.binary.getType(t.getBaseType(t.binary.contexts[0]))),t}})}var l=e.document;"atob"in e&&"btoa"in e||!function(){function t(e){var t,n,i,s,o,u;for(i=e.length,n=0,t="";i>n;){if(s=255&e.charCodeAt(n++),n==i){t+=r.charAt(s>>2),t+=r.charAt((3&s)<<4),t+="==";break}if(o=e.charCodeAt(n++),n==i){t+=r.charAt(s>>2),t+=r.charAt((3&s)<<4|(240&o)>>4),t+=r.charAt((15&o)<<2),t+="=";break}u=e.charCodeAt(n++),t+=r.charAt(s>>2),t+=r.charAt((3&s)<<4|(240&o)>>4),t+=r.charAt((15&o)<<2|(192&u)>>6),t+=r.charAt(63&u)}return t}function n(e){var t,n,r,s,o,u,a;for(u=e.length,o=0,a="";u>o;){do t=i[255&e.charCodeAt(o++)];while(u>o&&-1==t);if(-1==t)break;do n=i[255&e.charCodeAt(o++)];while(u>o&&-1==n);if(-1==n)break;a+=String.fromCharCode(t<<2|(48&n)>>4);do{if(r=255&e.charCodeAt(o++),61==r)return a;r=i[r]}while(u>o&&-1==r);if(-1==r)break;a+=String.fromCharCode((15&n)<<4|(60&r)>>2);do{if(s=255&e.charCodeAt(o++),61==s)return a;s=i[s]}while(u>o&&-1==s);if(-1==s)break;a+=String.fromCharCode((3&r)<<6|s)}return a}var r="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",i=[-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,62,-1,-1,-1,63,52,53,54,55,56,57,58,59,60,61,-1,-1,-1,-1,-1,-1,-1,0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,-1,-1,-1,-1,-1,-1,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,-1,-1,-1,-1,-1];e.btoa||(e.btoa=t),e.atob||(e.atob=n)}();var c=e.Promise||function(e){this.then=e},h=Object.create;h||(h=function(e){var t=function(){};return t.prototype=e,new t});var p=u.prototype,d=p.typeSet={};p.toValue=function(e){return s(this,this,e)},p._named=function(e,t,n){return e.displayName=t+" @ "+(void 0!==n?n:this.view.tell()),e};var v=Object.defineProperty;if(v)try{v({},"x",{})}catch(m){v=void 0}else v=function(e,t,n,r){r&&(e[t]=n.value)};var g="jBinary.Cache",y=0;p._getCached=function(e,t,n){if(e.hasOwnProperty(this.cacheKey))return e[this.cacheKey];var r=t.call(this,e);return v(e,this.cacheKey,{value:r},n),r},p.getContext=function(e){switch(typeof e){case"undefined":e=0;case"number":return this.contexts[e];case"string":return this.getContext(function(t){return e in t});case"function":for(var t=0,n=this.contexts.length;n>t;t++){var r=this.contexts[t];if(e.call(this,r))return r}}},p.inContext=function(e,t){this.contexts.unshift(e);var n=t.call(this);return this.contexts.shift(),n},a.prototype={inherit:function(e,t){function n(e,t){var n=s[e];n&&(r||(r=i(s)),t.call(r,n),r[e]=null)}var r,s=this;return n("params",function(t){for(var n=0,r=t.length;r>n;n++)this[t[n]]=e[n]}),n("setParams",function(t){t.apply(this,e)}),n("typeParams",function(e){for(var n=0,r=e.length;r>n;n++){var i=e[n],s=this[i];s&&(this[i]=t(s))}}),n("resolve",function(e){e.call(this,t)}),r||s},createProperty:function(e){return i(this,{binary:e,view:e.view})},toValue:function(e,t){return t!==!1&&"string"==typeof e?this.binary.getContext(e)[e]:s(this,this.binary,e)}},u.Type=a,f.prototype=i(a.prototype,{setParams:function(){this.baseType&&(this.typeParams=["baseType"].concat(this.typeParams||[]))},baseRead:function(){return this.binary.read(this.baseType)},baseWrite:function(e){return this.binary.write(this.baseType,e)}}),r(f.prototype,{read:f.prototype.baseRead,write:f.prototype.baseWrite}),u.Template=f,p.as=function(e,t){var n=t?this:i(this);return e=e||d,n.typeSet=e===d||d.isPrototypeOf(e)?e:i(d,e),n.cacheKey=g,n.cacheKey=n._getCached(e,function(){return g+"."+ ++y},!0),n},p.seek=function(e,t){if(e=this.toValue(e),void 0!==t){var n=this.view.tell();this.view.seek(e);var r=t.call(this);return this.view.seek(n),r}return this.view.seek(e)},p.tell=function(){return this.view.tell()},p.skip=function(e,t){return this.seek(this.tell()+this.toValue(e),t)},p.slice=function(e,t,n){return new u(this.view.slice(e,t,n),this.typeSet)},p._getType=function(e,t){switch(typeof e){case"string":if(!(e in this.typeSet))throw new ReferenceError("Unknown type: "+e);return this._getType(this.typeSet[e],t);case"number":return this._getType(d.bitfield,[e]);case"object":if(n(e,a)){var r=this;return e.inherit(t||[],function(e){return r.getType(e)})}return n(e,Array)?this._getCached(e,function(e){return this.getType(e[0],e.slice(1))},!0):this._getCached(e,function(e){return this.getType(d.object,[e])},!1)}},p.getType=function(e,t){var r=this._getType(e,t);return r&&!n(e,a)&&(r.name="object"==typeof e?n(e,Array)?e[0]+"("+e.slice(1).join(", ")+")":"object":String(e)),r},p._action=function(e,t,n){if(void 0!==e){e=this.getType(e);var r=this._named(function(){return n.call(this,e.createProperty(this),this.contexts[0])},"["+e.name+"]",t);return void 0!==t?this.seek(t,r):r.call(this)}},p.read=function(e,t){return this._action(e,t,function(e,t){return e.read(t)})},p.readAll=function(){return this.read("jBinary.all",0)},p.write=function(e,t,n){return this._action(e,n,function(e,n){var r=this.tell();return e.write(t,n),this.tell()-r})},p.writeAll=function(e){return this.write("jBinary.all",e,0)},function(e,t){for(var n=0,r=t.length;r>n;n++){var s=t[n];d[s.toLowerCase()]=i(e,{dataType:s})}}(a({params:["littleEndian"],read:function(){return this.view["get"+this.dataType](void 0,this.littleEndian)},write:function(e){this.view["write"+this.dataType](e,this.littleEndian)}}),["Uint8","Uint16","Uint32","Uint64","Int8","Int16","Int32","Int64","Float32","Float64","Char"]),r(d,{"byte":d.uint8,"float":d.float32,"double":d.float64}),d.array=f({params:["baseType","length"],read:function(){var e=this.toValue(this.length);if(this.baseType===d.uint8)return this.view.getBytes(e,void 0,!0,!0);var t;if(void 0!==e){t=new Array(e);for(var n=0;e>n;n++)t[n]=this.baseRead()}else{var r=this.view.byteLength;for(t=[];this.binary.tell()<r;)t.push(this.baseRead())}return t},write:function(e){if(this.baseType===d.uint8)return this.view.writeBytes(e);for(var t=0,n=e.length;n>t;t++)this.baseWrite(e[t])}}),d.binary=f({params:["length","typeSet"],read:function(){var e=this.binary.tell(),t=this.binary.skip(this.toValue(this.length)),n=this.view.slice(e,t);return new u(n,this.typeSet)},write:function(e){this.binary.write("blob",e.read("blob",0))}}),d.bitfield=a({params:["bitSize"],read:function(){return this.view.getUnsigned(this.bitSize)},write:function(e){this.view.writeUnsigned(e,this.bitSize)}}),d.blob=a({params:["length"],read:function(){return this.view.getBytes(this.toValue(this.length))},write:function(e){this.view.writeBytes(e,!0)}}),d["const"]=f({params:["baseType","value","strict"],read:function(){var e=this.baseRead();if(this.strict&&e!==this.value){if(n(this.strict,Function))return this.strict(e);throw new TypeError("Unexpected value ("+e+" !== "+this.value+").")}return e},write:function(e){this.baseWrite(this.strict||void 0===e?this.value:e)}}),d["enum"]=f({params:["baseType","matches"],setParams:function(e,t){this.backMatches={};for(var n in t)this.backMatches[t[n]]=n},read:function(){var e=this.baseRead();return e in this.matches?this.matches[e]:e},write:function(e){this.baseWrite(e in this.backMatches?this.backMatches[e]:e)}}),d.extend=a({setParams:function(){this.parts=arguments},resolve:function(e){for(var t=this.parts,n=t.length,r=new Array(n),i=0;n>i;i++)r[i]=e(t[i]);this.parts=r},read:function(){var e=this.parts,t=this.binary.read(e[0]);return this.binary.inContext(t,function(){for(var n=1,i=e.length;i>n;n++)r(t,this.read(e[n]))}),t},write:function(e){var t=this.parts;this.binary.inContext(e,function(){for(var n=0,r=t.length;r>n;n++)this.write(t[n],e)})}}),d["if"]=f({params:["condition","trueType","falseType"],typeParams:["trueType","falseType"],getBaseType:function(){return this.toValue(this.condition)?this.trueType:this.falseType}}),d.if_not=d.ifNot=f({setParams:function(e,t,n){this.baseType=["if",e,n,t]}}),d.lazy=f({marker:"jBinary.Lazy",params:["innerType","length"],getBaseType:function(){return["binary",this.length,this.binary.typeSet]},read:function(){var e=function(t){return 0===arguments.length?"value"in e?e.value:e.value=e.binary.read(e.innerType):r(e,{wasChanged:!0,value:t}).value};return e[this.marker]=!0,r(e,{binary:r(this.baseRead(),{contexts:this.binary.contexts.slice()}),innerType:this.innerType})},write:function(e){e.wasChanged||!e[this.marker]?this.binary.write(this.innerType,e()):this.baseWrite(e.binary)}}),d.object=a({params:["structure","proto"],resolve:function(e){var t={};for(var r in this.structure)t[r]=n(this.structure[r],Function)?this.structure[r]:e(this.structure[r]);this.structure=t},read:function(){var e=this,t=this.structure,r=this.proto?i(this.proto):{};return this.binary.inContext(r,function(){for(var i in t)this._named(function(){var s=n(t[i],Function)?t[i].call(e,r):this.read(t[i]);void 0!==s&&(r[i]=s)},i).call(this)}),r},write:function(e){var t=this,r=this.structure;this.binary.inContext(e,function(){for(var i in r)this._named(function(){n(r[i],Function)?e[i]=r[i].call(t,e):this.write(r[i],e[i])},i).call(this)})}}),d.skip=a({params:["length"],read:function(){this.view.skip(this.toValue(this.length))},write:function(){this.read()}}),d.string=f({params:["length","encoding"],read:function(){return this.view.getString(this.toValue(this.length),void 0,this.encoding)},write:function(e){this.view.writeString(e,this.encoding)}}),d.string0=a({params:["length","encoding"],read:function(){var e=this.view,t=this.length;if(void 0===t){var n,r=e.tell(),i=0;for(t=e.byteLength-r;t>i&&(n=e.getUint8());)i++;var s=e.getString(i,r,this.encoding);return t>i&&e.skip(1),s}return e.getString(t,void 0,this.encoding).replace(/\0.*$/,"")},write:function(e){var t=this.view,n=void 0===this.length?1:this.length-e.length;t.writeString(e,void 0,this.encoding),n>0&&(t.writeUint8(0),t.skip(n-1))}}),u.loadData=o(function(t,r){var i;if(n(t,e.Blob)){var s;if("FileReader"in e)s=new FileReader,s.onload=s.onerror=function(){r(this.error,this.result)},s.readAsArrayBuffer(t);else{s=new FileReaderSync;var o,u;try{u=s.readAsArrayBuffer(t)}catch(a){o=a}finally{r(o,u)}}}else if("string"!=typeof t)r(new TypeError("Unsupported source type."));else if(i=t.match(/^data:(.+?)(;base64)?,(.*)$/))try{var f=i[2],l=i[3];r(null,(f?atob:decodeURIComponent)(l))}catch(a){r(a)}else if("XMLHttpRequest"in e){var c=new XMLHttpRequest;c.open("GET",t,!0),"responseType"in c?c.responseType="arraybuffer":"overrideMimeType"in c?c.overrideMimeType("text/plain; charset=x-user-defined"):c.setRequestHeader("Accept-Charset","x-user-defined"),"onload"in c||(c.onreadystatechange=function(){4===this.readyState&&this.onload()});var h=function(e){r(new Error(e))};c.onload=function(){return 0!==this.status&&200!==this.status?h("HTTP Error #"+this.status+": "+this.statusText):("response"in this||(this.response=(new VBArray(this.responseBody)).toArray()),void r(null,this.response))},c.onerror=function(){h("Network error.")},c.send(null)}else r(new TypeError("Unsupported source type."))}),u.load=o(function(e,t,n){var r=u.loadData(e);u.load.getTypeSet(e,t,function(e){r.then(function(t){n(null,new u(t,e))},n)})}),u.load.getTypeSet=function(e,t,n){n(t)},p._toURI="URL"in e&&"createObjectURL"in URL?function(e){var t=this.seek(0,function(){return this.view.getBytes()});return URL.createObjectURL(new Blob([t],{type:e}))}:function(e){var t=this.seek(0,function(){return this.view.getString(void 0,void 0,"binary")});return"data:"+e+";base64,"+btoa(t)},p._mimeType=function(e){return e||this.typeSet["jBinary.mimeType"]||"application/octet-stream"},p.toURI=function(e){return this._toURI(this._mimeType(e))};if(l){var b=u.downloader=l.createElement("a");b.style.display="none"}return p.saveAs=o(function(e,t,n){"string"==typeof e?("msSaveBlob"in navigator?navigator.msSaveBlob(new Blob([this.read("blob",0)],{type:this._mimeType(t)}),e):l?(b.parentNode||l.body.appendChild(b),b.href=this.toURI(t),b.download=e,b.click(),b.href=b.download=""):n(new TypeError("Saving from Web Worker is not supported.")),n()):n(new TypeError("Unsupported storage type."))}),u}),function(e,t){typeof define=="function"&&define.amd?define("mpegts_to_mp4/mpegts",["jbinary"],t):typeof exports=="object"?module.exports=t(require("jbinary")):e.MPEGTS=t(e.jBinary)}(this,function(e){return{PCR:{pts:33,_reserved:6,extension:9},DynamicArray:e.Template({setParams:function(e,t){this.baseType={length:e,array:["array",t,"length"]}},read:function(){return this.baseRead().array},write:function(e){this.baseWrite({length:e.length,array:e})}}),Field:["DynamicArray","uint8","uint8"],Flag:e.Template({baseType:1,params:["dependentField"],write:function(e,t){this.baseWrite(this.dependentField in t?1:0)}}),FlagDependent:e.Template({params:["flagField","baseType"],read:function(){return this.binary.read(["if",this.flagField,this.baseType])}}),AdaptationField:{length:"uint8",_endOf:function(e){return this.binary.tell()+e.length},discontinuity:1,randomAccess:1,priority:1,_hasPCR:["Flag","pcr"],_hasOPCR:["Flag","opcr"],_hasSplicingPoint:["Flag","spliceCountdown"],_hasTransportPrivateData:["Flag","privateData"],_hasExtension:["Flag","extension"],pcr:["FlagDependent","_hasPCR","PCR"],opcr:["FlagDependent","_hasOPCR","PCR"],spliceCountdown:["FlagDependent","_hasSplicingPoint","uint8"],privateData:["FlagDependent","_hasTransportPrivateData","Field"],extension:["FlagDependent","_hasExtension","Field"],_toEnd:function(e){this.binary.seek(e._endOf)}},ES:{_rawStream:["blob",function(){return this.binary.getContext(1)._endof-this.binary.tell()}]},PATItem:["array",{programNumber:"uint16",_reserved:3,pid:13},function(e){return e._dataLength/4}],PMTHeader:{_reserved:3,pcrPID:13,_reserved2:4,programDescriptors:["DynamicArray",12,"uint8"]},PMTItem:{streamType:"uint8",_reserved:3,elementaryPID:13,_reserved2:4,esInfo:["DynamicArray",12,"uint8"]},PrivateSection:["extend",{pointerField:["if","payloadStart","uint8"],tableId:["enum","uint8",["PAT","CAT","PMT"]],isLongSection:1,isPrivate:1,_reserved:2,_sectionLength:12},["if","isLongSection",{tableIdExt:"uint16",_reserved:2,versionNumber:5,currentNextIndicator:1,sectionNumber:"uint8",lastSectionNumber:"uint8",_dataLength:function(){return this.binary.getContext(1)._sectionLength-9},data:e.Type({read:function(e){var t,n=this.binary.getContext(3),r=e._dataLength;switch(this.binary.getContext(1).tableId){case"PAT":t=this.binary.read("PATItem"),e.sectionNumber==0&&(n.pat={});for(var i=0;i<t.length;i++)n.pat[t[i].pid]=t[i];break;case"PMT":t=this.binary.read("PMTHeader"),t.mappings=[],r-=4+t.programDescriptors.length;while(r>0){var s=this.binary.read("PMTItem");t.mappings.push(s),r-=5+s.esInfo.length}e.sectionNumber==0&&(n.pmt={});for(var i=0;i<t.mappings.length;i++){var s=t.mappings[i];n.pmt[s.elementaryPID]=s}}return t}}),crc32:"uint32"},["blob","_sectionLength"]]],Packet:{_startof:function(){return this.binary.tell()},_endof:function(e){return e._startof+188},_syncByte:["const","uint8",71,!0],transportError:1,payloadStart:1,transportPriority:1,pid:13,scramblingControl:2,_hasAdaptationField:["Flag","adaptationField"],_hasPayload:["Flag","payload"],contCounter:4,adaptationField:["FlagDependent","_hasAdaptationField","AdaptationField"],payload:["FlagDependent","_hasPayload",e.Template({getBaseType:function(e){var t=e.pid,n=this.binary.getContext(1);if(t<2||t in n.pat)return"PrivateSection";if(t in n.pmt)return"ES"}})],_toEnd:function(e){this.binary.seek(e._endof)}},File:e.Template({baseType:["array","Packet"],read:function(){this.pat={},this.pmt={};var e=this;return this.binary.inContext(this,function(){return e.baseRead()})},write:function(e){var t=this;this.binary.inContext(this,function(){t.baseWrite(e)})}})}}),function(e,t){typeof define=="function"&&define.amd?define("mpegts_to_mp4/mp4",["jbinary"],t):typeof exports=="object"?module.exports=t(require("jbinary")):e.MP4=t(e.jBinary)}(this,function(e){function n(e){return function(t){return t.type===e}}var t=new Date(1970,0,1)-new Date(1904,0,1);return{ShortName:["string0",4],Rate:["FixedPoint","int32",16],Dimensions:e.Template({setParams:function(e){this.baseType={horz:e,vert:e}}}),BoxHeader:{_begin:function(){return this.binary.tell()},_size:e.Template({baseType:"uint32",write:function(e,t){var n=t.size;this.baseWrite(n?n<Math.pow(2,32)?n:1:0)}}),type:"ShortName",size:e.Type({read:function(e){var t=e._size;switch(t){case 0:return this.binary.view.byteLength-this.binary.tell()+8;case 1:return this.binary.read("uint64");default:return t}},write:function(e){e>=Math.pow(2,32)&&this.binary.write("uint64",e)}}),_end:function(e){return e._begin+e.size}},FullBox:["extend","BoxHeader",{version:"uint8",flags:24}],Box:e.Type({read:function(){var e=this.binary.skip(0,function(){return this.read("BoxHeader")}),t=this.binary.read(e.type)||e;return t===e&&console.log(e.type),this.binary.seek(e._end),t},write:function(e){this.binary.write(e.type,e);var t=this.binary.tell()-e._begin;this.binary.seek(e._begin,function(){this.write("uint32",t)})}}),Time:e.Template({params:["baseType"],read:function(){var e=this.baseRead();if(e)return new Date(e+t)},write:function(e){this.baseWrite(e-t>>>0)}}),FixedPoint:e.Template({params:["baseType"],setParams:function(e,t){this.coef=1<<t},read:function(){return this.baseRead()/this.coef},write:function(e){this.baseWrite(e*this.coef)}}),Atoms:e.Type({params:["end"],read:function(){var e={},t=this.toValue(this.end)||this.binary.getContext("_end")._end;while(this.binary.tell()<t){var n=this.binary.read("Box");(e[n.type]||(e[n.type]=[])).push(n)}return e},write:function(e){for(var t in e){var n=e[t];for(var r=0,i=n.length;r<i;r++)n[r].type=t,this.binary.write("Box",n[r])}}}),ChildAtoms:{atoms:"Atoms"},MultiBox:["extend","BoxHeader","ChildAtoms"],TransformationMatrix:{a:["FixedPoint","uint32",16],b:["FixedPoint","uint32",16],u:["FixedPoint","uint32",30],c:["FixedPoint","uint32",16],d:["FixedPoint","uint32",16],v:["FixedPoint","uint32",30],x:["FixedPoint","uint32",16],y:["FixedPoint","uint32",16],w:["FixedPoint","uint32",30]},Volume:["FixedPoint","uint16",8],FBVersionable:e.Template({setParams:function(e,t){this.baseType=["if","version",t,e]}}),FBUint:["FBVersionable","uint32","uint64"],FBTime:["Time","FBUint"],TimestampBox:["extend","FullBox",{creation_time:"FBTime",modification_time:"FBTime"}],DurationBox:["extend","TimestampBox",{timescale:"uint32",duration:"FBUint"}],ftyp:["extend","BoxHeader",{major_brand:"ShortName",minor_version:"uint32",compatible_brands:["array","ShortName",function(){return(this.binary.getContext(1)._end-this.binary.tell())/4}]}],free:"BoxHeader",RawData:{_rawData:["blob",function(){return this.binary.getContext("_end")._end-this.binary.tell()}]},mdat:["extend","BoxHeader","RawData"],ParamSets:e.Template({setParams:function(t){this.baseType=["DynamicArray",t,e.Template({baseType:{length:"uint16",paramSet:["blob","length"]},read:function(){return this.baseRead().paramSet},write:function(e){this.baseWrite({length:e.length,paramSet:e})}})]}}),avcC:["extend","BoxHeader",{version:["const","uint8",1],profileIndication:"uint8",profileCompatibility:"uint8",levelIndication:"uint8",_reserved:["const",6,-1],lengthSizeMinusOne:2,_reserved2:["const",3,-1],seqParamSets:["ParamSets",5],pictParamSets:["ParamSets","uint8"]}],moov:"MultiBox",mvhd:["extend","DurationBox",{rate:"Rate",volume:"Volume",_reserved:["skip",10],matrix:"TransformationMatrix",_reserved2:["skip",24],next_track_ID:"uint32"}],trak:"MultiBox",tkhd:["extend","TimestampBox",{track_ID:"uint32",_reserved:["skip",4],duration:"FBUint",_reserved2:["skip",8],layer:"int16",alternate_group:"uint16",volume:"Volume",_reserved3:["skip",2],matrix:"TransformationMatrix",dimensions:["Dimensions","Rate"]}],tref:"MultiBox",TrackReferenceTypeBox:["extend","BoxHeader",{track_IDs:["array","uint32",function(){return(this.binary.getContext(1)._end-this.binary.tell())/4}]}],hint:"TrackReferenceTypeBox",cdsc:"TrackReferenceTypeBox",hind:"TrackReferenceTypeBox",mdia:"MultiBox",mdhd:["extend","DurationBox",{_padding:1,lang:e.Type({read:function(){return String.fromCharCode.apply(String,this.binary.read(["array",5,3]).map(function(e){return e+96}))},write:function(e){for(var t=0;t<3;t++)this.binary.write(5,e.charCodeAt(t)-96)}}),_reserved:["skip",2]}],hdlr:["extend","FullBox",{_reserved:["skip",4],handler_type:"ShortName",_set_handler_type:function(e){this.binary.getContext(n("trak"))._handler_type=e.handler_type},_reserved2:["skip",12],name:"string0"}],minf:"MultiBox",vmhd:["extend","FullBox",{graphicsmode:"uint16",opcolor:{r:"uint16",g:"uint16",b:"uint16"}}],smhd:["extend","FullBox",{balance:["FixedPoint","int16",8],_reserved:["skip",2]}],hmhd:["extend","FullBox",{maxPDUsize:"uint16",avgPDUsize:"uint16",maxbitrate:"uint32",avgbitrate:"uint32",_reserved:["skip",4]}],stbl:"MultiBox",SampleEntry:["extend","BoxHeader",{_reserved:["skip",6],data_reference_index:"uint16"}],btrt:["extend","BoxHeader",{bufferSizeDB:"uint32",maxBitrate:"uint32",avgBitrate:"uint32"}],metx:["extend","SampleEntry",{content_encoding:"string0",namespace:"string0",schema_location:"string0",bitratebox:"btrt"}],mett:["extend","SampleEntry",{content_encoding:"string0",mime_format:"string0",bitratebox:"btrt"}],pasp:["extend","BoxHeader",{spacing:["Dimensions","uint32"]}],ClapInnerFormat:["Dimensions",{N:"uint32",D:"uint32"}],clap:["extend","BoxHeader",{cleanAperture:"ClapInnerFormat",off:"ClapInnerFormat"}],VisualSampleEntry:["extend","SampleEntry",{_reserved:["skip",16],dimensions:["Dimensions","uint16"],resolution:["Dimensions","Rate"],_reserved2:["skip",4],frame_count:["const","uint16",1],compressorname:e.Template({baseType:{length:"uint8",string:["string","length"],_skip:["skip",function(e){return 31-e.length}]},read:function(){return this.baseRead().string},write:function(e){this.baseWrite({length:e.length,string:e})}}),depth:"uint16",_reserved3:["const","int16",-1]},e.Type({setParams:function(){this.optional={cleanaperture:"clap",pixelaspectratio:"pasp"}},read:function(){var e={};for(var t in this.optional){var n=this.optional[t],r=this.binary.skip(0,function(){return this.read("BoxHeader")});r.type===n&&(e[t]=this.binary.read(n))}return e},write:function(e){for(var t in this.optional){var n=e[t];n&&this.binary.write(this.optional[t],n)}}}),"ChildAtoms"],AudioSampleEntry:["extend","SampleEntry",{_reserved:["skip",8],channelcount:"uint16",samplesize:"uint16",_reserved2:["skip",4],samplerate:"Rate"},"ChildAtoms"],DynamicArray:e.Template({setParams:function(e,t){this.baseType={length:e,array:["array",t,"length"]}},read:function(){return this.baseRead().array},write:function(e){this.baseWrite({length:e.length,array:e})}}),ArrayBox:e.Template({setParams:function(e){this.baseType=["extend","FullBox",{entries:["DynamicArray","uint32",e]}]}}),stsd:["ArrayBox",e.Template({getBaseType:function(){return{soun:"AudioSampleEntry",vide:"VisualSampleEntry",meta:"Box"}[this.binary.getContext(n("trak"))._handler_type]||"SampleEntry"},write:function(e){var t=this.binary.tell();this.baseWrite(e);var n=this.binary.tell()-t;this.binary.seek(t,function(){this.write("uint32",n)})}})],stdp:["extend","FullBox",{priorities:["array","uint16",function(){return this.binary.getContext(n("stbl"))._sample_count}]}],stsl:["extend","FullBox",{_reserved:7,constraint_flag:"bool",scale_method:["enum","uint8",[!1,"fill","hidden","meet","slice-x","slice-y"]],display_center:["Dimensions","int16"]}],stts:["ArrayBox",{sample_count:"uint32",sample_delta:"uint32"}],ctts:["ArrayBox",{sample_count:"uint32",sample_offset:"uint32"}],stss:["ArrayBox","uint32"],stsh:["ArrayBox",{shadowed_sample_number:"uint32",sync_sample_number:"uint32"}],ExtendedBoolean:["enum",2,[undefined,!0,!1]],sdtp:["extend","FullBox",{dependencies:["array",{_reserved:2,sample_depends_on:"ExtendedBoolean",sample_is_depended_on:"ExtendedBoolean",sample_has_redundancy:"ExtendedBoolean"},function(){return this.binary.getContext(n("stbl"))._sample_count}]}],edts:"MultiBox",elst:["ArrayBox",{segment_duration:"FBUint",media_time:["FBVersionable","int32","int64"],media_rate:"Rate"}],dinf:"MultiBox","url ":["extend","FullBox",{location:"string0"}],"urn ":["extend","FullBox",{name:"string0",location:"string0"}],dref:["ArrayBox","Box"],stsz:["extend","FullBox",{sample_size:"uint32",sample_count:"uint32",_sample_count_to_stbl:function(e){this.binary.getContext(n("stbl"))._sample_count=e.sample_count},sample_sizes:["if_not","sample_size",["array","uint32","sample_count"]]}],stz2:["extend","FullBox",{_reserved:["skip",3],field_size:"uint8",sample_count:"uint32",_sample_count_to_stbl:function(e){this.binary.getContext(n("stbl"))._sample_count=e.sample_count},sample_sizes:["array",e.Template({getBaseType:function(e){return e.field_size}}),"sample_count"]}],stsc:["ArrayBox",{first_chunk:"uint32",samples_per_chunk:"uint32",sample_description_index:"uint32"}],stco:["ArrayBox","uint32"],co64:["ArrayBox","uint64"],padb:["extend","FullBox",{pads:["DynamicArray","uint32",e.Template({baseType:{_skip:["const",1,0],pad:3},read:function(){return this.baseRead().pad},write:function(e){this.baseWrite({pad:e})}})]}],subs:["ArrayBox",{sample_delta:"uint32",subsamples:["DynamicArray","uint16",{subsample_size:["FBVersionable","uint16","uint32"],subsample_priority:"uint8",discardable:"uint8",_reserved:["skip",4]}]}],mvex:"MultiBox",mehd:["extend","FullBox",{fragment_duration:"FBUint"}],esds_section:["extend",{descriptor_type:"uint8",ext_type:e.Type({read:function(){var e=this.binary.read("uint8");if(e===128||e===129||e===254)return this.binary.skip(2),e;this.binary.skip(-1)},write:function(e){e!==undefined&&this.binary.write("blob",[e,e,e])}}),length:"uint8"},e.Template({getBaseType:function(t){switch(t.descriptor_type){case 3:return{es_id:"uint16",stream_priority:"uint8"};case 4:return{type:["enum","uint8",{1:"v1",2:"v2",32:"mpeg4_video",33:"mpeg4_avc_sps",34:"mpeg4_avc_pps",64:"mpeg4_audio",96:"mpeg2_simple_video",97:"mpeg2_main_video",98:"mpeg2_snr_video",99:"mpeg2_spatial_video",100:"mpeg2_high_video",101:"mpeg2_422_video",102:"mpeg4_adts_main",103:"mpeg4_adts_low_complexity",104:"mpeg4_adts_scaleable_sampling",105:"mpeg2_adts_main",106:"mpeg1_video",107:"mpeg1_adts",108:"jpeg_video",192:"private_audio",208:"private_video",224:"pcm_little_endian_audio",225:"vorbis_audio",226:"dolby_v3_audio",227:"alaw_audio",228:"mulaw_audio",229:"adpcm_audio",230:"pcm_big_endian_audio",240:"yv12_video",241:"h264_video",242:"h263_video",243:"h261_video"}],stream_type:["enum",6,[null,"object","clock","scene","visual","audio","mpeg-7","ipmp","oci","mpeg-java"]],upstream_flag:1,_reserved:["const",1,1],buffer_size:24,maxBitrate:"uint32",avgBitrate:"uint32"};case 5:return{audio_profile:["enum",5,[null,"aac-main","aac-lc","aac-ssr","aac-ltp","sbr","aac-scalable","twinvq","celp","hxvc",null,null,"ttsi","main-synthesis","wavetable-synthesis","general-midi","algorithmic-synthesis-and-audio-effects","er-aac-lc","reserved","er-aac-ltp","er-aac-scalable","er-twinvq","er-bsac","er-aac-ld","er-celp","er-hvxc","er-hiln","er-parametric","ssc","ps","mpeg-surround"]],sampling_freq:e.Type({setParams:function(){this.freqList=[96e3,88200,64e3,48e3,44100,32e3,24e3,22050,16e3,12e3,11025,8e3,7350]},read:function(){var e=this.binary.read(4);return e!==15?this.freqList[e]:this.binary.read(24)},write:function(e){var t=this.freqList.indexOf(e);t!==-1?this.binary.write(4,t):(this.binary.write(4,15),this.binary.write(24,e))}}),channelConfig:4,frameLength:["enum",1,[1024,960]],dependsOnCoreCoder:1,extensionFlag:1};case 6:return{sl:["const","uint8",2]}}}})],esds:["extend","FullBox",{sections:e.Template({baseType:"esds_section",read:function(){var e=this.binary.getContext("_end")._end,t=[];while(this.binary.tell()<e)t.push(this.baseRead());return t},write:function(e){for(var t=0,n=e.length;t<n;t++)this.baseWrite(e[t])}})}],File:["Atoms",function(){return this.binary.view.byteLength}]}}),function(e,t){typeof define=="function"&&define.amd?define("mpegts_to_mp4/h264",["jbinary"],t):typeof exports=="object"?module.exports=t(require("jbinary")):e.H264=t(e.jBinary)}(this,function(e){return{ExpGolomb:e.Type({params:["isSigned"],read:function(){var e=0;while(!this.binary.read(1))e++;var t=1<<e|this.binary.read(e);return this.isSigned?t&1?-(t>>1):t>>1:t-1},write:function(e){this.isSigned?(e<<=1,e<=0&&(e=-e|1)):e++;var t=e.toString(2).length;this.binary.write(t-1,0),this.binary.write(t,e)}}),Optional:e.Template({params:["baseType"],read:function(){if(this.binary.read(1))return this.baseRead()},write:function(e){this.binary.write(e!=null?1:0),e!=null&&this.baseWrite(e)}}),ScalingList:e.Template({setParams:function(e){this.baseType=["array",{},e]}}),SPS:["extend",{profile_idc:"uint8",constraint_set_flags:["array",1,8],level_idc:"uint8",seq_parameter_set_id:"ExpGolomb"},["if",function(e){return[100,110,122,244,44,83,86,118].indexOf(e.profile_idc)>=0},{chroma_format:["enum","ExpGolomb",["MONO","YUV420","YUV422","YUV444"]],separate_color_plane_flag:["if",function(e){return e.chroma_format==="YUV444"},1],bit_depth_luma_minus8:"ExpGolomb",bit_depth_chroma_minus8:"ExpGolomb",qpprime_y_zero_transform_bypass_flag:1,scaling_matrix:["Optional",{scalingList4x4:["array",["ScalingList",16],6],scalingList8x8:["array",["ScalingList",64],function(){return this.binary.getContext(1).chroma_format!=="YUV444"?2:6}]}]}],{log2_max_frame_num_minus4:"ExpGolomb",pic_order_cnt_type:"ExpGolomb",pic_order:["if_not","pic_order_cnt_type",{log2_max_pic_order_cnt_lsb_minus4:"ExpGolomb"},["if",function(e){return e.pic_order_cnt_type===1},{delta_pic_order_always_zero_flag:1,offset_for_non_ref_pic:["ExpGolomb",!0],offset_for_top_to_bottom_field:["ExpGolomb",!0],_num_ref_frames_in_pic_order_cnt_cycle:e.Template({baseType:"ExpGolomb",write:function(e,t){this.baseWrite(t.offset_for_ref_frame.length)}}),offset_for_ref_frame:["array",["ExpGolomb",!0],function(e){return e._num_ref_frames_in_pic_order_cnt_cycle}]}]],max_num_ref_frames:"ExpGolomb",gaps_in_frame_num_value_allowed_flag:1,pic_width_in_mbs_minus_1:"ExpGolomb",pic_height_in_map_units_minus_1:"ExpGolomb",frame_mbs_only_flag:1,mb_adaptive_frame_field_flag:["if_not","frame_mbs_only_flag",1],direct_8x8_inference_flag:1,frame_cropping:["Optional",{left:"ExpGolomb",right:"ExpGolomb",top:"ExpGolomb",bottom:"ExpGolomb"}]}],NALUnit:e.Type({read:function(){var e=this.binary.read(["blob",3]);e[2]===0&&this.binary.skip(1);var t=this.binary.view.byteLength,n=this.binary.tell(),r=this.binary.skip(0,function(){return this.view.getBytes()});for(var i=1,s=r.length-3;i<s;i++)if(r[i]===0&&r[i+1]===0&&(r[i+2]===1||r[i+2]===0&&r[i+3]===1)){t=n+i;break}var o=this.binary.read(["blob",t-n]);return o}})}}),function(e,t){typeof define=="function"&&define.amd?define("mpegts_to_mp4/pes",["jbinary"],t):typeof exports=="object"?module.exports=t(require("jbinary")):e.PES=t(e.jBinary)}(this,function(e){return{Flag:e.Template({baseType:1,params:["dependentField"],write:function(e,t){this.baseWrite(this.dependentField in t?1:0)}}),FlagDependent:e.Template({params:["flagField","baseType"],read:function(){return this.binary.read(["if",this.flagField,this.baseType])}}),PESTimeStamp:e.Template({setParams:function(e){var t=["const",1,1,!0];this.baseType={_prefix:["const",4,e,!0],hiPart:3,_skip1:t,midPart:15,_skip2:t,loPart:15,_skip3:t}},read:function(){var e=this.baseRead();return e.loPart|e.midPart<<15|e.hiPart<<30},write:function(e){this.baseWrite({hiPart:e>>>30,midPart:e>>>15&32767,loPart:e&32767})}}),PESPacket:["extend",{_startCode0:["const","uint8",0,!0],_startCode1:["const","uint8",0,!0],_startCode2:["const","uint8",1,!0],streamId:"uint8",length:"uint16",_end:function(e){var t=this.binary.tell(),n=e.length;if(n){t+=n;if(t>this.view.byteLength-4)return t;var r=this.binary.read(["blob",4],t);if(r[0]===0&&r[1]===0&&r[2]===1&&r[3]&128)return t;t-=n}var i=this.view.byteLength,r=this.binary.read("blob",t);for(var s=0;s<r.length-4;s++)if(r[s]===0&&r[s+1]===0&&r[s+2]===1&&r[s+3]&128)return t+s;return i}},e.Template({baseType:{_marker:["const",2,2,!0],scramblingControl:["enum",2,["not_scrambled"]],priority:1,dataAlignmentIndicator:1,hasCopyright:1,isOriginal:1,_hasPTS:["Flag","pts"],_hasDTS:["Flag","dts"],_hasESCR:["Flag","escr"],_hasESRate:["Flag","esRate"],dsmTrickMode:1,_hasAdditionalCopyInfo:["Flag","additionalCopyInfo"],_hasPESCRC:["Flag","pesCRC"],_hasExtension:["Flag","extension"],dataLength:"uint8",_headerEnd:function(e){return this.binary.tell()+e.dataLength},pts:["FlagDependent","_hasPTS",["if","_hasDTS",["PESTimeStamp",3],["PESTimeStamp",2]]],dts:["FlagDependent","_hasDTS",["PESTimeStamp",1]],_toHeaderEnd:function(e){this.binary.seek(e._headerEnd)}},read:function(){var e=this.binary.tell();try{return this.baseRead()}catch(t){this.binary.seek(e),this.binary.view.alignBy()}}}),{data:["blob",function(){return this.binary.getContext("_end")._end-this.binary.tell()}]}]}}),function(e,t){typeof define=="function"&&define.amd?define("mpegts_to_mp4/adts",[],t):typeof exports=="object"?module.exports=t():e.ADTS=t()}(this,function(){return{ADTSPacket:{_start:function(){return this.binary.tell()},_syncWord:["const",12,4095,!0],version:["enum",1,["mpeg-4","mpeg-2"]],layer:["const",2,0],isProtectionAbsent:1,profileMinusOne:2,samplingFreq:["enum",4,[96e3,88200,64e3,48e3,44100,32e3,24e3,22050,16e3,12e3,11025,8e3,7350]],_privateStream:1,channelConfig:3,_reserved:4,frameLength:13,bufferFullness:11,aacFramesCountMinusOne:2,data:["blob",function(e){return e.frameLength-(this.binary.tell()-e._start)}]}}}),function(e,t){typeof define=="function"&&define.amd?define("mpegts_to_mp4/index",["jdataview","jbinary","./mp4","./h264","./pes","./adts"],t):typeof exports=="object"?module.exports=t(require("jdataview"),require("jbinary"),require("./mp4"),require("./h264"),require("./pes"),require("./adts")):e.mpegts_to_mp4=t(e.jDataView,e.jBinary,e.MP4,e.H264,e.PES,e.ADTS)}(this,function(e,t,n,r,i,s){return function(o){var u=o.read("File"),a=new e(o.view.byteLength);for(var f=0,l=u.length;f<l;f++){var c=u[f],h=c.adaptationField,p=c.payload;p&&p._rawStream&&a.writeBytes(p._rawStream)}var d=new t(a.slice(0,a.tell()),i),v=new t(a.byteLength,s),m=[],g=[];a=new e(a.byteLength);while(d.tell()<d.view.byteLength){var c=d.read("PESPacket");if(c.streamId===192)v.write("blob",c.data);else if(c.streamId===224){var y=new t(c.data,r),b=c.pts,w=c.dts,E={offset:a.tell(),pts:b,dts:w!==undefined?w:b};m.push(E);while(y.tell()<y.view.byteLength){var S=y.read("NALUnit");switch(S[0]&31){case 7:if(!x){var x=S,T=(new t(x,r)).read("SPS"),N=(T.pic_width_in_mbs_minus_1+1)*16,C=(2-T.frame_mbs_only_flag)*(T.pic_height_in_map_units_minus_1+1)*16,k=T.frame_cropping;k&&(N-=2*(k.left+k.right),C-=2*(k.top+k.bottom))}break;case 8:if(!L)var L=S;break;case 5:E.isIDR=!0;default:a.writeUint32(S.length),a.writeBytes(S)}}}}m.push({offset:a.tell()});var A=[],O=[],M=[],_=[],D=m[0],P={sum:0,count:0},H=0;for(var f=0,l=m.length-1;f<l;f++){var B=m[f+1];A.push(B.offset-D.offset);var j=B.dts-D.dts;j?(O.push({sample_count:1,sample_delta:j}),H+=j,P.sum+=j,P.count++):O.length++,D.isIDR&&M.push(f+1),_.push({first_chunk:_.length+1,sample_count:1,sample_offset:D.dtsFix=D.pts-D.dts}),D=B}P=Math.round(P.sum/P.count);for(var f=0,l=O.length;f<l;f++)O[f]===undefined&&(O[f]={first_chunk:f+1,sample_count:1,sample_delta:P},H+=P);var F=!0;for(var f=1,l=O.length;f<l;f++)if(O[f].sample_delta!==O[0].sample_delta){F=!1;break}F&&(O=[{first_chunk:1,sample_count:A.length,sample_delta:O[0].sample_delta}]);var I=a.tell(),q=v.tell(),R=[],U,z=0;v.seek(0);while(v.tell()<q)U=v.read("ADTSPacket"),R.push(U.data.length),U.data.length>z&&(z=U.data.length),a.writeBytes(U.data);var W=new t(a.byteLength,n),X=[{atoms:{tkhd:[{version:0,flags:15,track_ID:1,duration:H,layer:0,alternate_group:0,volume:1,matrix:{a:1,b:0,x:0,c:0,d:1,y:0,u:0,v:0,w:1},dimensions:{horz:N,vert:C}}],mdia:[{atoms:{mdhd:[{version:0,flags:0,timescale:9e4,duration:H,lang:"und"}],hdlr:[{version:0,flags:0,handler_type:"vide",name:"VideoHandler"}],minf:[{atoms:{vmhd:[{version:0,flags:1,graphicsmode:0,opcolor:{r:0,g:0,b:0}}],dinf:[{atoms:{dref:[{version:0,flags:0,entries:[{type:"url ",version:0,flags:1,location:""}]}]}}],stbl:[{atoms:{stsd:[{version:0,flags:0,entries:[{type:"avc1",data_reference_index:1,dimensions:{horz:N,vert:C},resolution:{horz:72,vert:72},frame_count:1,compressorname:"",depth:24,atoms:{avcC:[{version:1,profileIndication:T.profile_idc,profileCompatibility:parseInt(T.constraint_set_flags.join(""),2),levelIndication:T.level_idc,lengthSizeMinusOne:3,seqParamSets:[x],pictParamSets:[L]}]}}]}],stts:[{version:0,flags:0,entries:O}],stss:[{version:0,flags:0,entries:M}],ctts:[{version:0,flags:0,entries:_}],stsc:[{version:0,flags:0,entries:[{first_chunk:1,samples_per_chunk:A.length,sample_description_index:1}]}],stsz:[{version:0,flags:0,sample_size:0,sample_count:A.length,sample_sizes:A}],stco:[{version:0,flags:0,entries:[40]}]}}]}}]}}]}}];q>0&&X.push({atoms:{tkhd:[{version:0,flags:15,track_ID:2,duration:H,layer:0,alternate_group:1,volume:1,matrix:{a:1,b:0,x:0,c:0,d:1,y:0,u:0,v:0,w:1},dimensions:{horz:0,vert:0}}],mdia:[{atoms:{mdhd:[{version:0,flags:0,timescale:9e4,duration:H,lang:"eng"}],hdlr:[{version:0,flags:0,handler_type:"soun",name:"SoundHandler"}],minf:[{atoms:{smhd:[{version:0,flags:0,balance:0}],dinf:[{atoms:{dref:[{version:0,flags:0,entries:[{type:"url ",version:0,flags:1,location:""}]}]}}],stbl:[{atoms:{stsd:[{version:0,flags:0,entries:[{type:"mp4a",data_reference_index:1,channelcount:2,samplesize:16,samplerate:22050,atoms:{esds:[{version:0,flags:0,sections:[{descriptor_type:3,ext_type:128,length:34,es_id:2,stream_priority:0},{descriptor_type:4,ext_type:128,length:20,type:"mpeg4_audio",stream_type:"audio",upstream_flag:0,buffer_size:0,maxBitrate:Math.round(z/(H/9e4/R.length)),avgBitrate:Math.round((a.tell()-I)/(H/9e4))},{descriptor_type:5,ext_type:128,length:2,audio_profile:U.profileMinusOne+1,sampling_freq:U.samplingFreq,channelConfig:U.channelConfig},{descriptor_type:6,ext_type:128,length:1,sl:2}]}]}}]}],stts:[{version:0,flags:0,entries:[{sample_count:R.length,sample_delta:Math.round(H/R.length)}]}],stsc:[{version:0,flags:0,entries:[{first_chunk:1,samples_per_chunk:R.length,sample_description_index:1}]}],stsz:[{version:0,flags:0,sample_size:0,sample_count:R.length,sample_sizes:R}],stco:[{version:0,flags:0,entries:[40+I]}]}}]}}]}}]}});var V=new Date;return W.write("File",{ftyp:[{major_brand:"isom",minor_version:512,compatible_brands:["isom","iso2","avc1","mp41"]}],mdat:[{_rawData:a.getBytes(a.tell(),0)}],moov:[{atoms:{mvhd:[{version:0,flags:0,creation_time:V,modification_time:V,timescale:9e4,duration:H,rate:1,volume:1,matrix:{a:1,b:0,x:0,c:0,d:1,y:0,u:0,v:0,w:1},next_track_ID:2}],trak:X}}]}),W.slice(0,W.tell())}}),typeof console=="undefined"&&["assert","clear","count","debug","dir","dirxml","error","exception","group","groupCollapsed","groupEnd","info","log","markTimeline","profile","profileEnd","table","timeStamp","trace","warn"].forEach(function(e){this[e]=function(){postMessage({type:"debug",action:e,args:Array.prototype.slice.call(arguments)})}},console={}),define("consoleWorker",function(e){return function(){var t,n;return t||e.console}}(this)),console.time||function(e){var t={},n={};this.time=function(n){t[n]=e.now()},this.timeEnd=function(r){var i=e.now()-t[r];r in n||(n[r]={sum:0,count:0,valueOf:function(){return this.sum/this.count}}),n[r].sum+=i,n[r].count++,this.log(r+": "+i+" ms"),delete t[r]}}.call(console,typeof performance!="undefined"&&"now"in performance?performance:Date),define("consoleTime",["consoleWorker"],function(e){return function(){var t,n;return t||e.console}}(this)),require(["async","jbinary","./mpegts_to_mp4/mpegts","./mpegts_to_mp4/index","consoleTime","consoleWorker"],function(e,t,n,r){addEventListener("message",function(i){e.eachSeries(i.data,function(e,i){t.load(e.url,n,function(t,n){i(t);if(t)return;console.time("convert");var s=r(n);console.timeEnd("convert"),postMessage({type:"video",index:e.index,original:e.url,url:s.toURI("video/mp4")})})})}),postMessage({type:"ready"})}),define("worker",function(){});';
  var worker = new Worker( URL.createObjectURL(new Blob([workerSrc])) );

  var nextIndex = 0;
  var sentVideos = 0;
  var currentVideo = null;
  var videos = [];
  var lastOriginal;
  var context = canvas.getContext('2d');

  canvas.play = function() { if(currentVideo) currentVideo.play(); };
  canvas.pause = function() { if(currentVideo) currentVideo.pause(); };
  canvas.stop = function() {
    if(currentVideo) currentVideo.pause();
    if(worker) {
      worker.terminate();
      worker = null;
    }
  }

  // drawing new frame
  function nextFrame() {
    if (currentVideo.paused || currentVideo.ended) {
      return;
    }
    context.drawImage(currentVideo, 0, 0);
    requestAnimationFrame(nextFrame);
  }

  worker.addEventListener('message', function (event) {
    var data = event.data, descriptor = '#' + data.index + ': ' + data.original;

    switch (data.type) {
      // worker is ready to convert
      case 'ready':
        getMore();
        return;

      // got debug message from worker
      case 'debug':
        Function.prototype.apply.call(console[data.action], console, data.args);
        return;

      // got new converted MP4 video data
      case 'video':
        var video = document.createElement('video'), source = document.createElement('source');
        source.type = 'video/mp4';
        video.appendChild(source);

        video.addEventListener('loadedmetadata', function () {
          if (canvas.width !== this.videoWidth || canvas.height !== this.videoHeight) {
            canvas.width = this.width = this.videoWidth;
            canvas.height = this.height = this.videoHeight;
          }
        });

        video.addEventListener('play', function () {
          if (currentVideo !== this) {
            if (!currentVideo) {
              if(!options.autoplay)
                this.pause();

              if(typeof(options.canplay) == "function")
                options.canplay.call(this);
            }

            currentVideo = this;
            nextIndex++;
            if (sentVideos - nextIndex <= 1) {
              getMore();
            }
          }
          nextFrame();
        });

        video.addEventListener('ended', function () {
          delete videos[nextIndex - 1];
          if (nextIndex in videos) {
            videos[nextIndex].play();
          }
        });
        if (video.src.slice(0, 5) === 'blob:') {
          video.addEventListener('ended', function () {
            URL.revokeObjectURL(this.src);
          });
        }

        video.src = source.src = data.url;
        video.load();

        (function canplaythrough() {
          videos[data.index] = this;
          if ((!currentVideo || currentVideo.ended) && data.index === nextIndex) {
            this.play();
          }
        }).call(video);

        return;
    }
  });

  // relative URL resolver
  var resolveURL = (function () {
    var doc = document,
      old_base = doc.getElementsByTagName('base')[0],
      old_href = old_base && old_base.href,
      doc_head = doc.head || doc.getElementsByTagName('head')[0],
      our_base = old_base || doc.createElement('base'),
      resolver = doc.createElement('a'),
      resolved_url;

    return function (base_url, url) {
      old_base || doc_head.appendChild(our_base);

      our_base.href = base_url;
      resolver.href = url;
      resolved_url  = resolver.href; // browser magic at work here

      old_base ? old_base.href = old_href : doc_head.removeChild(our_base);

      return resolved_url;
    };
  })();

  function getMore() {
    var ajax = new XMLHttpRequest();
    ajax.addEventListener('load', function () {
      var originals =
        this.responseText
        .split(/\r?\n/)
        .filter(RegExp.prototype.test.bind(/\.ts$/))
        .map(resolveURL.bind(null, manifestUrl));

      originals = originals.slice(originals.lastIndexOf(lastOriginal) + 1);
      lastOriginal = originals[originals.length - 1];

      worker.postMessage(originals.map(function (url, index) {
        return {url: url, index: sentVideos + index};
      }));

      sentVideos += originals.length;

      //console.log('asked for ' + originals.length + ' more videos');
    });
    ajax.open('GET', manifestUrl, true);
    ajax.send();
  }

  return canvas;

};
return HLSPlayer;
}));
